---
format: 
   revealjs:
      theme: ["../theme/q-theme.scss"]
      slide-number: c/t
      logo: POPUHEALSMPH_color-flush.png
      code-copy: true
      center-title-slide: false
      code-link: true
      code-overflow: wrap
      highlight-style: a11y
      height: 1080
      width: 1920
      chalkboard: true
      from: markdown+emoji
      fragment: true
      auto-stretch: false
      pdf-separate-fragments: true
execute: 
   eval: true
   echo: true
editor: 
  markdown: 
    wrap: 72
---

```{r load libraries, echo=F}
library(tidyverse)
library(gridExtra)
library(qrcode)
library(KMsurv)
library(survival)
library(survminer)
data(larynx)
data(heart)
```

<h1>Lecture 12.1: Time-dependent covariates & time-varying regression coefficients</h1>

<h2>PHS 651: Advanced regression methods</h2>

<hr>

<h3>Mary Ryan Baumann, PhD</h3>

<h3>November 25, 2025</h3>

<br>

::: {style="font-size: 75%;"}
**Recording disclosure**

*This class is being conducted in person, as well as over [Zoom]{.alert}. As the instructor, I will be [recording]{.alert} this session. I have disabled the recording feature for others so that no one else will be able to record this session. I will be posting this session to the course’s website.*

*If you have privacy concerns and do not wish to appear in the recording, you may turn video off (click “stop video”) so that Zoom does not record you.*

*The chat box is always open for discussion and questions to the entire class. You may also send messages privately to the instructor. Please note that Zoom saves all chat transcripts.*
:::

::: {.absolute bottom=100 left=260 width=1500}

Slides found at: <https://maryryan.github.io/PHS-651-slides/F25/lec-12-1/slides-12-1>

:::

::: {.absolute bottom=50 left=100 width=150}
```{r qr code, echo=F, fig.height=2, fig.width=2}
plot(qr_code("https://maryryan.github.io/PHS-651-slides/F25/lec-12-1/slides-12-1"))
```
:::

---

## Roadmap

- Recap: Cox PH regression

- Recap: Static time-to-event data format

- Time-dependent/repeated measures covariates

   - Counting process data format
   
   - Using in a Cox regression model

- Time-varying coefficients

   - Schoenfeld residuals
   
   - Testing proportional hazards
   
   - Using in a Cox regression model

---

## Recap: Cox model regression

Last time we introduced the [Cox model]{.alert}, which is a semi-parameteric [proportional hazards]{.underline} regression that uses covariates to estimate a log-hazard:
$$\log\left[\lambda_i(t)\right] = \beta_0(t) + \beta_1 x_{i1} + \dots + \beta_k x_{ik}$$

- It is [semi-parametric]{.alert} because it [leaves the baseline hazard $\beta_0(t)$ unspecified]{.underline} (only $\beta_1, \dots, \beta_k$ have parametric forms)

- $\beta$ is interpreted as a log hazard ratio - but we usually like to [interpret $e^\beta$ to get regular hazard ratios]{.alert}

<br>

Together with the [Breslow estimator]{.alert} of the baseline cumulative hazard, 

$$\hat \Lambda_{0B}(t) = \sum_{t_i \le t} \frac{d_i}{\sum_{j\in R(t_i)}\exp(\hat\beta_1 x_{j1} + \hat\beta_k x_{jk})}$$

we can use the coefficients from a Cox model to estimate the survival and hazard functions of individuals with specific covariate values, as well as probabilities of survival at particular timepoints

---

## Recap: Time-to-event regression data format

The data we use for our Cox models usually includes 3 essential elements:

1. Whether an individual experience an event (event indicator)

2. The length of time we observed an individual (time)

3. At least one covariate/exposure


:::: {.columns}

::: {.column width="50%"}

- If an individual [experiences an event]{.underline} while we're observing them, the time variable will represent the time at which that event occurred (["event time"]{.alert})

<br>

- If an individual [does not experience an event]{.underline} while we're observing the, the time variable will represent the last timepoint at which we observed that individual (["censoring time"]{.alert})

:::

::: {.column width="50%"}

```{r larynx, echo=F}
larynx
```

:::

::::

---

## Recap: Time-to-event regression data format

:::: {.columns}

::: {.column width="50%"}

- If an individual [experiences an event]{.underline} while we're observing them, the time variable will represent the time at which that event occurred (["event time"]{.alert})

<br>

- If an individual [does not experience an event]{.underline} while we're observing the, the time variable will represent the last timepoint at which we observed that individual (["censoring time"]{.alert})

:::

::: {.column width="50%"}

```{r larynx2, echo=F}
larynx
```

:::

::::

<br>

This is why when we code models for time to event endpoints, we "bundle" the time and event indicator variables together in the outcome:

:::: {.columns}
::: {.column width="50%"}
```{r cox ex, eval=F}
coxph( Surv(time, event) ~ covariate )
```
:::

::: {.column width="50%"}
```{sas cox ex2, eval=F}
PROC PHREG DATA=data;
  MODEL time*event(0) = covariate / TIES=EFRON;
RUN;
```
:::
::::

---

## Time-dependent covariates
:::: {.columns}

::: {.column width="50%"}

Note that in this data there is only 1 row per individual

:::

::: {.column width="50%"}

```{r larynx3, echo=F}
larynx
```

:::

::::

<br>

What happens if we were to collect a variable that [changes over time]{.alert}?

- Do we just include baseline value? Value at event/censoring time? Average value?

- None of these solutions is very satisfying... would be nice if we could just record how that variable changes like with repeated measures data

---

## Time-dependent covariates

Below is data on patients who are on the wait list for the Standard heart transplant program, where we want to see if receiving a transplant reduces hazard of death:
```{r heart subset,echo=F}
jasa_subset <-jasa %>% 
   select(-c("birth.dt", "hla.a2","mscore","reject","mismatch"))
jasa_subset %>% 
   select(!age)
```

- `transplant`: indicator for whether patient received a transplant

- `fustat`: indicator for whether patient is alive or dead

- `wait.time`: time to transplant since entering the program

- `futime`: total observation time (time to censoring or death)

[Whether someone receives a transplant or not is a variable that changes with time!]{.alert} (did not have a transplant prior to `tx.date`)

---

## Time-dependent covariates

Below is data on patients who were on the wait list for the Standard heart transplant program:
```{r heart2, echo=F}
jasa_subset %>% 
   select(-age)
```

Because transplant status changes with time, we need to transform this data into a new format in order to analyze it

- We call this new format the [counting process format]{.alert}, which has potentially [multiple rows]{.alert} for each individual

- Each row represents a [time interval]{.alert} that corresponds to a particular value for their time-dependent variable

- If they only have one row, that means none of the values for their covariates changed over the observation period

---

## Counting process format

Below is an example of what the heart transplant data would look like in counting process format:
```{r heart_long format, echo=F}
jasa2 <- cbind(1:nrow(jasa_subset), jasa_subset) #we need an identifier variable
colnames(jasa2)[1] <- "id"
tdata <- with(jasa2, data.frame(id = id,
   futime= pmax(.5, fu.date - accept.dt),
   txtime= ifelse(tx.date== fu.date,
   (tx.date -accept.dt) -.5,
   (tx.date - accept.dt)),
   fustat = fustat
   ))
xdata <- tmerge(jasa2, tdata, id=id,
   death = event(futime, fustat),
   transplant = tdc(txtime),
   options= list(idname="id"))

sdata <- tmerge(jasa2, tdata, id=id,
   death = event(futime, fustat),
   trt = tdc(txtime),
   options= list(idname="id"))
sdata <- sdata %>% 
   rename(death_ever=fustat,
          transplant_ever=transplant) %>% 
   rename(transplant = trt)
```
```{r heart_long, echo=F}
sdata %>% 
   select(-c("accept.dt","tx.date","fu.date","futime","wait.time","surgery"))
```

- `tstart`, `tstop`: variables for the beginning and end of an observation interval

- `transplant`: indicator for whether the patient has a transplanted heart [in the interval]{.underline}

- `death`: whether the patient has died [by the end of the interval]{.underline}

---

## Counting process format

The difference in format is a little more obvious if we look just at the people who received a transplant:

```{r heart_long treaters, echo=F}
sdata %>% 
   select(-c("accept.dt","tx.date","fu.date","futime","wait.time","surgery")) %>% 
   filter(transplant_ever==1) 
```

<br>

With counting process format data, our time variable is now 2 separate variables: interval start time and interval stop time



---

## Time-dependent Cox model

To model this data, instead of just bundling together the event indicator and the event time, we'll bundle both start and stop times together with the event indicator:

```{r cox time}
time.cox <- coxph( Surv(tstart, tstop, death) ~ transplant + age + surgery, data=sdata)
summary(time.cox)$coef
```

- $e^{\beta_1(transplant)}=$ `r round(summary(time.cox)$coef[1,2],4)`: [A patient who had a transplant by any given time $t$ are expected to have a [`r (round(summary(time.cox)$coef[1,2],4)-1)*100`% higher hazard of death]{.alert} compared to a non-transplant patient of similar age and prior surgery status (non-significant).]{.fragment}

---

## Time-dependent Cox model

```{r cox time21}
summary(time.cox)$coef
```

<br>

Let's compare this to what the estimated model coefficients would look like if we weren't looking at transplant status as a time-varying coefficient:
```{r cox}
heart.cox <- coxph( Surv(futime, fustat) ~ transplant + age + surgery, data=jasa)
summary(heart.cox)$coef
```

- $e^{\beta_1(transplant)}=$ `r round(summary(heart.cox)$coef[1,2],4)`: A patient who had a transplant are expected to have a [`r (1-round(summary(heart.cox)$coef[1,2],4))*100`% lower hazard of death]{.alert} compared to a non-transplant patient of similar age and prior surgery status.

---

## Time-dependent Cox model

[Time-dependent model]{.underline}:

- $e^{\beta_1(transplant)}=$ `r round(summary(time.cox)$coef[1,2],4)`: A patient who had a transplant by any given time $t$ are expected to have a `r (round(summary(time.cox)$coef[1,2],4)-1)*100`% [higher]{.alert} hazard of death compared to a non-transplant patient of similar age and prior surgery status (non-significant).

[Time-static model]{.underline}:

- $e^{\beta_1(transplant)}=$ `r round(summary(heart.cox)$coef[1,2],4)`: A patient who had a transplant are expected to have a `r (1-round(summary(heart.cox)$coef[1,2],4))*100`% [lower]{.alert} hazard of death compared to a non-transplant patient of similar age and prior surgery status.

[These are wildly different results! Why?]{.alert}


- In the non-time-dependent regression, transplant looks like it has such a large effect on time to death because the only people who receive transplants are [those that live long enough to get them]{.underline} and likely judged to be "not too sick" to be able to benefit from them

---

## Time-varying coefficients

We may also be interested in whether the [effect]{.alert} of a covariate [changes with time]{.underline}

- Known as a time-varying coefficient

<br>

This is a separate concept from time-dependent covariates

- Time-dependent covariates - covariate values can change, but the effect of a particular value is constant across time: $\log[\lambda_i(t)] = \beta_0(t) + \beta_k \color{red}{x_{ik}(t)}$

- Time-varying coefficients - covariate value is fixed, but its effect varies with time: $\log[\lambda_i(t)] = \beta_0(t) + \color{red}{\beta_k(t)} x_{ik}$

---

## Time-varying coefficients

Time-varying coefficients are an example of [non-proportional hazards]{.alert}

- When we model a truly time-varying coefficient as time-static
$$\log[\lambda_i(t)] = \beta_0(t) + \beta_k x_{ik}$$
$e^{\beta_k}$ represents the hazard ratio for $X_k$ [averaged over time]{.alert}

<br>

- If the hazard at early times is very different from that at late times, the average may not be of interest to us

<br>

There are several ways we can formally look at this:

- [Schoenfeld residual]{.alert} plot for a covariate

- Score test of correlation between a covariate's Schoenfeld residual and time

---

## Graphically assessing proportional hazards assumption

A [Schoenfeld residual]{.alert} is the difference between the covariate value for a subject and the weighted average of covariates in the risk set

- If the proportional hazards assumption holds and $\beta$ is the true regression coefficient, the residuals are uncorrelated and have mean zero

- If a covariate has a time-varying coefficent $\beta(t) = \beta + \gamma g(t)$, then we expect the scaled Schoenfeld residuals at a specific time will be $\gamma g(t)$

We usually [scale]{.alert} the Schoenfeld residuals by the weighted covariance matrix of $\widehat \beta$

- If we [plot the scaled Schoenfeld residuals for a covariate against time and see a trend]{.underline}, that indicates that we might have non-proportional hazards

---

## Schoenfeld residuals plot

For example, let's look at the laryngeal cancer data again

```{r larynx resid}
larynx.cox <- coxph( Surv(time, delta) ~ factor(stage) + age, data=larynx)
sresid <- residuals(larynx.cox, type="scaledsch")
time <- as.numeric( rownames( sresid ) )
sresid <- cbind(as.data.frame(sresid), time)

sresid %>% 
   ggplot(aes(x=time, y=age))+
   geom_point(size=2)+
   geom_smooth(size=1.5,se=F)+
   geom_hline(yintercept=0)+
   theme_minimal()+theme(text=element_text(size=16))

```

::: {.absolute bottom=250 right=50 width="40%"}
We might be seeing a slight pattern... Is there a way to formally test?
:::

---

## Testing proportional hazards assumption

Remember that if a covariate has a time-varying coefficent $\beta(t) = \beta + \gamma g(t)$, then we expect the scaled Schoenfeld residuals at a specific time will be $\gamma g(t)$

We can perform a hypothesis test for whether $\gamma=0$

- If we fail to reject, then we don't have strong evidence that the proportional hazards assumption is violated

- If we reject, then we have evidence that proportional hazards doesn't hold

. . .

```{r larynx zph}
cox.zph( larynx.cox, transform="identity" )
```

- Test indicates that we [don't have strong evidence]{.underline} that proportional hazards is violated for either the disease stage or age variables

   - Could be that proportional hazards actually holds
   
   - Could be that we just don't have a large enough sample size to have the precision needed to detect it

---

## Testing proportional hazards assumption

Remember that if a covariate has a time-varying coefficent $\beta(t) = \beta + \gamma g(t)$, then we expect the scaled Schoenfeld residuals at a specific time will be $\gamma g(t)$

We can perform a hypothesis test for whether $\gamma=0$

- If we fail to reject, then we don't have strong evidence that the proportional hazards assumption is violated

- If we reject, then we have evidence that proportional hazards doesn't hold

We can also plot the `cox.zph()` object to get the Schoenfeld residual plots we made earlier:

```{r larynx zph2}
plot(cox.zph( larynx.cox, transform="identity" )[2])
```

---

## Time-varying coefficients

If we did have evidence of non-proportional hazards, we could incorporate time-varying coefficeints into our Cox model

We can think of time-varying coefficients as a sort of [interaction]{.alert} between covariate and time:
$$\log[\lambda_i(t)] = \beta_0(t) + \beta_k x_{ik} + \beta_I(x_{ik} \times \text{time}_i)$$

- Much like an exposure-by-time interaction in longitudinal GEEs and GLMMs, but the main-effect for time is absorbed into $\beta_0(t)$

---

## Time-varying coefficients

We can think of time-varying coefficients as a sort of [interaction]{.alert} between covariate and time:

$$\log[\lambda_i(t)] = \beta_0(t) + \beta_k x_{ik} + \beta_t(x_{ik} \times \text{time}_i)$$

There are different ways to interact time with a covariate $X_k$. You might consider:

- Linear time: $\log[\lambda_i(t)] = \beta_0(t) + \beta_k x_{ik} + \beta_t(x_{ik} \times \text{time}_i)$

- Log time: $\log[\lambda_i(t)] = \beta_0(t) + \beta_k x_{ik} + \beta_t(x_{ik} \times \log[\text{time}_i])$ [It's common to go with log time]{.alert}

- Categorical time:
$$\begin{align*}\log[\lambda_i(t)] = &\beta_0(t) + \beta_k x_{ik} + \beta_{t1}(x_{ik} \times I(0 <\text{time}_i \le t_1)])\\
&+ \beta_{t2}(x_{ik} \times I(t_1 <\text{time}_i \le t_2)]) + \dots + \beta_{tp}(x_{ik} \times I(t_{p-1} <\text{time}_i \le t_p)])\end{align*}$$

- Time with splines

---

## Time-varying coefficients

When adding time-varying coefficients to a Cox model, it's not just interacting a covariate with someone's end survival time -- it's interacting the covariate with [each unit of time in the observation window]{.alert}

- This is essentially putting the data in counting process format, but each time interval is the length 1 unit on the time scale (e.g., 1 day)

- This makes for an enormous dataset, and fitting these models can be very computationally intensive

<br>

In R, there is a slightly easier way to do this via the time-transform argument in the `coxph()` function

```{r varying}
summary( coxph( Surv(tstart, tstop, death) ~ age + surgery + transplant + tt(transplant), data=sdata,
                tt=function(x,t, ...) x * log(t+1)) )$coef
```

---

## Time-varying coefficients

When time-varying coefficents are added, it's most helpful to compare individuals at 2 different time points (such as $time=1$ and $time=365$ ) to understand how the hazard ratio changes with time

```{r contrasts}
heart.tt <- coxph( Surv(tstart, tstop, death) ~ age + surgery + transplant + tt(transplant), data=sdata,
                tt=function(x,t, ...) x * log(t+1))

time1 <- c(0,0,1,log(1))
time365 <- c(0,0,1,log(365))

time1.exp <- exp(t(summary(heart.tt)$coef[,1]) %*% time1)
time365.exp <- exp(t(summary(heart.tt)$coef[,1]) %*% time365)
```

Ignoring the fact that neither the transplant nor the time-varying coefficients were statistically significant...

- $e^{\beta_{transplant}(1) +\beta_{tt}(1\times \log(1))}$: `r round(time1.exp, 4)`

- $e^{\beta_{transplant}(1) +\beta_{tt}(1\times \log(365))}$: `r round(time365.exp, 4)`

The hazard for death for heart transplant patients is high right after the transplant, but reduces later on

---

## Take home messages

- Accommodating [covariates/variables whose values change with time]{.underline} requires us to put the data into [counting process format]{.alert}

   - If a covariate/variable can change with time, it can be important to incorporate this to understand survival bias

<br>

- It's also possible for the [effect of a covariate to change with time]{.underline} -- this creates [non-proportional hazards]{.alert}

   - We can assess non-proportional hazards in a covariate using Schoenfeld residual plots, or a non-proportional hazards test

<br>

- If we have evidence of non-proportional hazards in a covariate, it's then worthwhile to model the time-varying coefficient by interacting the covariate with time

   - Then important to compare the estimated effect of the covariate at 2 different timepoints to understand how the effect changes with time!