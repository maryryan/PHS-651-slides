---
format: 
   revealjs:
      theme: ["../theme/q-theme.scss"]
      slide-number: c/t
      logo: POPUHEALSMPH_color-flush.png
      code-copy: true
      center-title-slide: false
      code-link: true
      code-overflow: wrap
      highlight-style: a11y
      height: 1080
      width: 1920
      chalkboard: true
      from: markdown+emoji
      fragment: true
      auto-stretch: false
execute: 
   eval: true
   echo: true
editor: 
  markdown: 
    wrap: 72
---

```{r load libraries, echo=F}
library(tidyverse)
library(ggdag)
library(dagitty)
library(gridExtra)
library(qrcode)
```

```{r radon, echo=F}
radon <- read.table("~/Desktop/teaching/PHS-651/data/Gelman-data/radon/srrs2.dat",header=T,sep=",")

set.seed(081524)

radon.mn <- radon %>% 
   as.data.frame() %>% 
   mutate(log_radon = log(activity +0.1),
          county = str_trim(county)) %>% 
   dplyr::filter(state == "MN")
```

<h1>Lecture 3.1: GEEs for non-Normal data</h1>

<h2>PHS 651: Advanced regression methods</h2>

<hr>

<h3>Mary Ryan Baumann, PhD</h3>

<h3>September 25, 2025</h3>

<br>

::: {style="font-size: 75%;"}
**Recording disclosure**

*This class is being conducted in person, as well as over [Zoom]{.alert}. As the instructor, I will be [recording]{.alert} this session. I have disabled the recording feature for others so that no one else will be able to record this session. I will be posting this session to the course’s website.*

*If you have privacy concerns and do not wish to appear in the recording, you may turn video off (click “stop video”) so that Zoom does not record you.*

*The chat box is always open for discussion and questions to the entire class. You may also send messages privately to the instructor. Please note that Zoom saves all chat transcripts.*
:::

::: {.absolute bottom=50 left=260 width=1500}

Slides found at: <https://maryryan.github.io/PHS-651-slides/F25/lec-3-2/slides-3-2>

:::

::: {.absolute bottom=0 left=100 width=150}
```{r qr code, echo=F, fig.height=2, fig.width=2}
plot(qr_code("https://maryryan.github.io/PHS-651-slides/F25/lec-3-2/slides-3-2"))
```
:::

---

## GEEs and non-Normal data

We can also extend GEEs to non-Normal outcome data

Recall: GEEs find the $\beta$ that solves an estimating equation of the
general form:
$$\sum_{i=1}^N \left(\frac{\partial \mu_i}{\partial \beta}\right)^T V_i^{-1}[y_{ij} - \mu_{ij}(\vec{\beta})] = 0$$

. . .

[So what's different?]{.alert}

. . .

- We have a link function $g(\cdot)$ that isn't the identity function

. . .

- Since $g(\cdot)$ isn't the identity function, $\left(\frac{\partial \mu_i}{\partial \beta}\right)^T \ne \boldsymbol{X}$

. . .

- The (co)variance $V_i$ will likely depend on $\mu_{ij}$

   - With Normal data, $v(\cdot)$ was independent of $\mu_{ij}$
   
---

## GEEs: cancer remission

Let's see how this would work with a binary outcome

- Recall our cancer remission example

- Want to see whether years of physician experience impacts whether a patient’s lung cancer goes into remission after treatment, adjusted for disease stage

```{r cancer data cleaning, echo=F}
library(gee)
cancer <- read.csv("https://stats.idre.ucla.edu/stat/data/hdp.csv")

cancer <- within(cancer, {
  Married <- factor(Married, levels = 0:1, labels = c("no", "yes"))
  DID <- factor(DID)
  HID <- factor(HID)
  CancerStage <- factor(CancerStage)
})

cancer <- cancer %>% 
   as.data.frame() %>% 
   rename(doc_ID=DID)
```

We're assuming:

- Mean model: 

- Variance: 

- Correlation structure: 

---

## GEEs: cancer remission

Let's see how this would work with a binary outcome

- Recall our cancer remission example

- Want to see whether years of physician experience impacts whether a patient’s lung cancer goes into remission after treatment, adjusted for disease stage

We're assuming:

- Mean model: $logit\left(E[\text{remission}_{ij}|\vec{X}_{ij}]\right) = \beta_0 + \beta_1(\text{experience}_i) + \beta_2(\text{Stage2}_{ij}) + \beta_3(\text{Stage3}_{ij}) + \beta_4(\text{Stage4}_{ij})$

- Variance: $Var[Y_{ij}] = E[\text{remission}_{ij}|\vec{X}_{ij}]\left(1-E[\text{remission}_{ij}|\vec{X}_{ij}]\right)$

- Correlation structure: exchangeable

. . .

Let's run it

---

## GEEs: cancer remission

Let's run it:

```{r cancer gee}
# run a GEE with random intercepts for county #
cancer_gee <- gee( remission ~ Experience + CancerStage,
                  id=doc_ID, data=cancer,
                  family=binomial,
                  corstr="exchangeable" )
summary( cancer_gee )$coef
```

- $e^{\beta_1}$: `r round(exp(summary(cancer_gee)$coef[2,1]),4)`

. . .

- Naive 95% CI: (`r round(exp(summary(cancer_gee)$coef[2,1] - summary(cancer_gee)$coef[2,2]*qnorm(0.975)), 4)`, `r round(exp(summary(cancer_gee)$coef[2,1] + summary(cancer_gee)$coef[2,2]*qnorm(0.975)), 4)`)

- Robust 95% CI: (`r round(exp(summary(cancer_gee)$coef[2,1] - summary(cancer_gee)$coef[2,4]*qnorm(0.975)), 4)`, `r round(exp(summary(cancer_gee)$coef[2,1] + summary(cancer_gee)$coef[2,4]*qnorm(0.975)), 4)`)

<!-- ------------------------------------------------------------------------ -->

<!-- ## GEE limitations -->

<!-- Since we're only specifying mean and covariance structures, though, this -->
<!-- means that our GEE won't behave nicely when we deviate from those -->
<!-- structures (more on this later in the semester) -->

<!-- -   By loosening distributional assumptions, we've placed more reliance -->
<!--     on *structure* -->

------------------------------------------------------------------------

## GLMMs vs GEEs

We noted that GEEs are *marginal* models while GLMMS are *conditional*
models...

. . .

[What are some other differences between GEEs and GLMMs?]{.alert}

. . .

|                            | GEE                                                                    | GLMM |
|----------------------------|------------------------------------------------------------------------|----------------------------------------------|
| Interpretation             | Population-level                                                       | Cluster-level                                |
| Accounting for correlation | Empirical estimation                                                   | Specification of random effects              |
| Assumptions                | Weak assumptions; more robust (correlation structure, over-dispersion) | Strong assumptions; less robust              |
| Sample size requirements   | Moderately large ($n > 50$)                                            | Works with smaller sample sizes provided that the entire model is correctly specified |
| Computational burden       | Light                                                                  | Heavy                                        |
| Cluster-level prediction?  | No                                                                     | Yes                                          |
: {tbl-colwidths="[20,40,40]"}

---

## GLMMs vs GEEs: radon

With these differences in mind, let's see how they compare in analyzing our Minnesota radon data

- Recall that we want to estimate how the floor we measure on affects radon measurements in Minnesota houses

. . .

[Do we expect there to be a difference in the estimates given by the LME and GEE?]{.alert}

---

## GLMMs vs GEEs: radon

Recall our GEE model

```{r radon gee}
# run a GEE with exchangeable correlation clustered on counties #
radon_gee <- gee( log_radon ~ floor,
                  id=cntyfips, # cluster ID needs to be a number, not names or categories
                  data=radon.mn, corstr="exchangeable" )
summary( radon_gee )$coef
```

---

## GLMMs vs GEEs: radon

Let's fit our LME model:
$$\text{log radon}_{ij} = \beta_0 + \beta_1(\text{floor}_{ij}) + b_{0i} + \epsilon_{ij}$$

. . .

```{r radon lme}
library(lme4)

# run an LME with random intercepts for county #
radon_lme <- lmer( log_radon ~ floor + (1 | county), data=radon.mn )
summary( radon_lme )$coef
```

:::: {.columns}

::: {.column width="50%"}

::: {.fragment}

- LME $\beta_1$: `r round(summary(radon_lme)$coef[2,1],4)`

   - Model-based 95% CI: (`r round(summary(radon_lme)$coef[2,1] - summary(radon_lme)$coef[2,2]*qnorm(0.975), 4)`, `r round(summary(radon_lme)$coef[2,1] + summary(radon_lme)$coef[2,2]*qnorm(0.975), 4)`)

:::

:::

::: {.column width="50%"}

::: {.fragment}

Compared to our GEE:

- GEE $\beta_1$: `r round(summary(radon_gee)$coef[2,1],4)`

   - Model-based 95% CI: (`r round(summary(radon_gee)$coef[2,1] - summary(radon_gee)$coef[2,2]*qnorm(0.975), 4)`, `r round(summary(radon_gee)$coef[2,1] + summary(radon_gee)$coef[2,2]*qnorm(0.975), 4)`)
   
   - Robust 95% CI: (`r round(summary(radon_gee)$coef[2,1] - summary(radon_gee)$coef[2,4]*qnorm(0.975), 4)`, `r round(summary(radon_gee)$coef[2,1] + summary(radon_gee)$coef[2,4]*qnorm(0.975), 4)`)

:::

:::

::::

::: {.fragment}

[Not much difference!]{.alert}

:::

---

## GLMMs vs GEEs: cancer remission

Now let's try an analysis with our cancer remission example

- Want to see whether years of physician experience impacts whether a patient’s lung cancer goes into remission after treatment, adjusted for disease stage

. . .

[Do we expect there to be a difference in the estimates given by the LME and GEE?]{.alert}

---

## GLMMs vs GEEs: cancer remission

First our LME model:

$$\text{logit}(\text{remission}_{ij}) = \beta_0 + \beta_1(\text{experience}_i) + \beta_2(\text{Stage2}_{ij}) + \beta_3(\text{Stage3}_{ij}) + \beta_4(\text{Stage4}_{ij}) + b_{0i} + \epsilon_{ij}$$

. . .

```{r cancer glmm}
library(MASS)
cancer_glmm <- glmmPQL( remission ~ Experience + CancerStage,
         random = ~ 1 | doc_ID, family = binomial, data = cancer, 
         verbose = F )
summary( cancer_glmm )$tTable

```

:::: {.columns}
::: {.column width="30%"}
::: {.fragment}

Logistic GLMM results:

- GLMM $e^{\beta_1}$: `r round(exp(cancer_glmm$coefficients$fixed[2]), 4)`

   - 95% CI: (`r round(exp(cancer_glmm$coefficients$fixed[2] - summary(cancer_glmm)$tTable[2,2]*qnorm(0.975)), 4)`, `r round(exp(cancer_glmm$coefficients$fixed[2] + summary(cancer_glmm)$tTable[2,2]*qnorm(0.975)), 4)`)

:::
:::

::: {.column width="30%"}
::: {.fragment}

Compared to our GEE:

- GEE $e^{\beta_1}$: `r round(exp(summary(cancer_gee)$coef[2,1]),4)`

   - Model-based 95% CI: (`r round(exp(summary(cancer_gee)$coef[2,1] - summary(cancer_gee)$coef[2,2]*qnorm(0.975)), 4)`, `r round(exp(summary(cancer_gee)$coef[2,1] + summary(cancer_gee)$coef[2,2]*qnorm(0.975)), 4)`)
   
   - Robust 95% CI: (`r round(exp(summary(cancer_gee)$coef[2,1] - summary(cancer_gee)$coef[2,4]*qnorm(0.975)), 4)`, `r round(exp(summary(cancer_gee)$coef[2,1] + summary(cancer_gee)$coef[2,4]*qnorm(0.975)), 4)`)

:::
:::

::: {.column width="33%"}
::: {.fragment}

[A pretty big difference!]{.alert}

- Went from an effect size of `r round((exp(cancer_glmm$coefficients$fixed[2])-1)*100, 2)`% higher odds of remission for each extra year of experience in the GLMM to `r round((exp(summary(cancer_gee)$coef[2,1])-1)*100,2)`% higher odds in the GEE. [Why?]{.fragment .alert}
:::
:::
::::


<!-- IS THIS A BIGGER EFFECT BC THE EXPOSURE IS AT THE CLUSTER LEVEL? -->
